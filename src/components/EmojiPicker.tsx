"use client";

import { useState, useRef, useEffect, useMemo } from "react";

interface EmojiPickerProps {
    value: string;
    onChange: (emoji: string) => void;
    className?: string;
    guildId?: string;
}

interface CustomEmoji {
    id: string;
    name: string;
    animated: boolean;
    available: boolean;
}

// Standard Categories
const CATEGORIES = [
    { id: "people", label: "People", icon: "ğŸ˜€", emojis: ["ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ¤£", "ğŸ˜‚", "ğŸ™‚", "ğŸ˜Š", "ğŸ˜‡", "ğŸ¥°", "ğŸ˜", "ğŸ¤©", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜š", "ğŸ˜‹", "ğŸ˜›", "ğŸ˜œ", "ğŸ¤ª", "ğŸ˜", "ğŸ¤‘", "ğŸ¤—", "ğŸ¤­", "ğŸ¤«", "ğŸ¤”", "ğŸ¤", "ğŸ¤¨", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¶", "ğŸ˜", "ğŸ˜’", "ğŸ™„", "ğŸ˜¬", "ğŸ¤¥", "ğŸ˜Œ", "ğŸ˜”", "ğŸ˜ª", "ğŸ¤¤", "ğŸ˜´", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤¢", "ğŸ¤®", "ğŸ¥´", "ğŸ˜µ", "ğŸ¤¯", "ğŸ¤ ", "ğŸ¥³", "ğŸ˜", "ğŸ¤“", "ğŸ§", "ğŸ˜•", "ğŸ˜Ÿ", "ğŸ™", "â˜¹ï¸", "ğŸ˜®", "ğŸ˜¯", "ğŸ˜²", "ğŸ˜³", "ğŸ¥º", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜±", "ğŸ˜–", "ğŸ˜£", "ğŸ˜", "ğŸ˜“", "ğŸ˜©", "ğŸ˜«", "ğŸ¥±", "ğŸ˜¤", "ğŸ˜¡", "ğŸ˜ ", "ğŸ¤¬", "ğŸ˜ˆ", "ğŸ‘¿", "ğŸ’€", "â˜ ï¸", "ğŸ’©", "ğŸ¤¡", "ğŸ‘¹", "ğŸ‘º", "ğŸ‘»", "ğŸ‘½", "ğŸ‘¾", "ğŸ¤–", "ğŸ˜º", "ğŸ˜¸", "ğŸ˜¹", "ğŸ˜»", "ğŸ˜¼", "ğŸ˜½", "ğŸ™€", "ğŸ˜¿", "ğŸ˜¾", "ğŸ™ˆ", "ğŸ™‰", "ğŸ™Š", "ğŸ’‹", "ğŸ’Œ", "ğŸ’˜", "ğŸ’", "ğŸ’–", "ğŸ’—", "ğŸ’“", "ğŸ’", "ğŸ’•", "ğŸ’Ÿ", "â£ï¸", "ğŸ’”", "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ¤", "ğŸ–¤", "ğŸ¤", "ğŸ’¯", "ğŸ’¢", "ğŸ’¥", "ğŸ’«", "ğŸ’¦", "ğŸ’¨", "ğŸ•³ï¸", "ğŸ’£", "ğŸ’¬", "ğŸ‘ï¸â€ğŸ—¨ï¸", "ğŸ—¨ï¸", "ğŸ—¯ï¸", "ğŸ’­", "ğŸ’¤"] },
    { id: "nature", label: "Nature", icon: "ğŸŒ²", emojis: ["ğŸµ", "ğŸ’", "ğŸ¦", "ğŸ¶", "ğŸ•", "ğŸ¦®", "ğŸ•â€ğŸ¦º", "ğŸ©", "ğŸº", "ğŸ¦Š", "ğŸ¦", "ğŸ±", "ğŸˆ", "ğŸˆâ€â¬›", "ğŸ¦", "ğŸ¯", "ğŸ…", "ğŸ†", "ğŸ´", "ğŸ", "ğŸ¦„", "ğŸ¦“", "ğŸ¦Œ", "ğŸ®", "ğŸ‚", "ğŸƒ", "ğŸ„", "ğŸ·", "ğŸ–", "ğŸ—", "ğŸ½", "ğŸ", "ğŸ‘", "ğŸ", "ğŸª", "ğŸ«", "ğŸ¦™", "ğŸ¦’", "ğŸ˜", "ğŸ¦", "ğŸ¦›", "ğŸ­", "ğŸ", "ğŸ€", "ğŸ¹", "ğŸ°", "ğŸ‡", "ğŸ¿ï¸", "ğŸ¦”", "ğŸ¦‡", "ğŸ»", "ğŸ»â€â„ï¸", "ğŸ¨", "ğŸ¼", "ğŸ¦¥", "ğŸ¦¦", "ğŸ¦¨", "ğŸ¦˜", "ğŸ¦¡", "ğŸ¾", "ğŸ¦ƒ", "ğŸ”", "ğŸ“", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¦", "ğŸ§", "ğŸ•Šï¸", "ğŸ¦…", "ğŸ¦†", "ğŸ¦¢", "ğŸ¦‰", "ğŸ¦©", "ğŸ¦š", "ğŸ¦œ", "ğŸ¸", "ğŸŠ", "ğŸ¢", "ğŸ¦", "ğŸ", "ğŸ²", "ğŸ‰", "ğŸ¦•", "ğŸ¦–", "ğŸ³", "ğŸ‹", "ğŸ¬", "ğŸŸ", "ğŸ ", "ğŸ¡", "ğŸ¦ˆ", "ğŸ™", "ğŸš", "ğŸŒ", "ğŸ¦‹", "ğŸ›", "ğŸœ", "ğŸ", "ğŸ", "ğŸ¦—", "ğŸ•·ï¸", "ğŸ•¸ï¸", "ğŸ¦‚", "ğŸ¦Ÿ", "ğŸ¦ ", "ğŸ’", "ğŸŒ¸", "ğŸ’®", "ğŸµï¸", "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ»", "ğŸŒ¼", "ğŸŒ·", "ğŸŒ±", "ğŸª´", "ğŸŒ²", "ğŸŒ³", "ğŸŒ´", "ğŸŒµ", "ğŸŒ¾", "ğŸŒ¿", "â˜˜ï¸", "ğŸ€", "ğŸ", "ğŸ‚", "ğŸƒ"] },
    { id: "food", label: "Food", icon: "ğŸ”", emojis: ["ğŸ‡", "ğŸˆ", "ğŸ‰", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ", "ğŸ¥­", "ğŸ", "ğŸ", "ğŸ", "ğŸ‘", "ğŸ’", "ğŸ“", "ğŸ«", "ğŸ¥", "ğŸ…", "ğŸ«’", "ğŸ¥¥", "ğŸ¥‘", "ğŸ†", "ğŸ¥”", "ğŸ¥•", "ğŸŒ½", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸ¥’", "ğŸ¥¬", "ğŸ¥¦", "ğŸ§„", "ğŸ§…", "ğŸ„", "ğŸ¥œ", "ğŸŒ°", "ğŸ", "ğŸ¥", "ğŸ¥–", "ğŸ«“", "ğŸ¥¨", "ğŸ¥¯", "ğŸ¥", "ğŸ§‡", "ğŸ§€", "ğŸ–", "ğŸ—", "ğŸ¥©", "ğŸ¥“", "ğŸ”", "ğŸŸ", "ğŸ•", "ğŸŒ­", "ğŸ¥ª", "ğŸŒ®", "ğŸŒ¯", "ğŸ«”", "ğŸ¥™", "ğŸ§†", "ğŸ¥š", "ğŸ³", "ğŸ¥˜", "ğŸ²", "ğŸ«•", "ğŸ¥£", "ğŸ¥—", "ğŸ¿", "ğŸ§ˆ", "ğŸ§‚", "ğŸ¥«", "ğŸ±", "ğŸ˜", "ğŸ™", "ğŸš", "ğŸ›", "ğŸœ", "ğŸ", "ğŸ ", "ğŸ¢", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¥®", "ğŸ¡", "ğŸ¥Ÿ", "ğŸ¥ ", "ğŸ¥¡", "ğŸ¦€", "ğŸ¦", "ğŸ¦", "ğŸ¦‘", "ğŸ¦ª", "ğŸ¦", "ğŸ§", "ğŸ¨", "ğŸ©", "ğŸª", "ğŸ‚", "ğŸ°", "ğŸ§", "ğŸ¥§", "ğŸ«", "ğŸ¬", "ğŸ­", "ğŸ®", "ğŸ¯", "ğŸ¼", "ğŸ¥›", "â˜•", "ğŸ«–", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸ·", "ğŸ¸", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ¥‚", "ğŸ¥ƒ", "ğŸ¥¤", "ğŸ§‹", "ğŸ§ƒ", "ğŸ§‰", "ğŸ§Š", "ğŸ¥¢", "ğŸ½ï¸", "ğŸ´", "ğŸ¥„", "ğŸ”ª", "ğŸº"] },
    { id: "activity", label: "Activities", icon: "âš½", emojis: ["ğŸƒ", "ğŸ„", "ğŸ†", "ğŸ‡", "ğŸ§¨", "âœ¨", "ğŸˆ", "ğŸ‰", "ğŸŠ", "ğŸ‹", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ‘", "ğŸ§§", "ğŸ€", "ğŸ", "ğŸ—ï¸", "ğŸŸï¸", "ğŸ«", "ğŸ–ï¸", "ğŸ†", "ğŸ…", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "âš½", "âš¾", "ğŸ¥", "ğŸ€", "ğŸ", "ğŸˆ", "ğŸ‰", "ğŸ¾", "ğŸ¥", "ğŸ³", "ğŸ", "ğŸ‘", "ğŸ’", "ğŸ¥", "ğŸ“", "badminton", "ğŸ¥Š", "ğŸ¥‹", "ğŸ¥…", "â›³", "â›¸ï¸", "ğŸ£", "ğŸ¤¿", "ğŸ½", "ğŸ¿", "ğŸ›·", "ğŸ¥Œ", "ğŸ¯", "ğŸª€", "ğŸª", "ğŸ±", "ğŸ”®", "ğŸª„", "ğŸ§¿", "ğŸ®", "ğŸ•¹ï¸", "ğŸ°", "ğŸ²", "ğŸ§©", "ğŸ§¸", "â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸", "â™Ÿï¸", "ğŸƒ", "ğŸ€„", "ğŸ´", "ğŸ­", "ğŸ–¼ï¸", "ğŸ¨", "ğŸ§µ", "ğŸ§¶"] },
    { id: "travel", label: "Travel", icon: "ğŸš—", emojis: ["ğŸš—", "ğŸš•", "ğŸš™", "ğŸšŒ", "ğŸš", "ğŸï¸", "ğŸš“", "ğŸš‘", "ğŸš’", "ğŸš", "ğŸ›»", "ğŸšš", "ğŸš›", "ğŸšœ", "ğŸ¦¯", "ğŸ¦½", "ğŸ¦¼", "ğŸ›´", "ğŸš²", "ğŸ›µ", "ğŸï¸", "ğŸ›º", "ğŸš¨", "ğŸš”", "ğŸš", "ğŸš˜", "ğŸš–", "ğŸš¡", "ğŸš ", "ğŸšŸ", "ğŸšƒ", "ğŸš‹", "ğŸš", "ğŸš", "ğŸš„", "ğŸš…", "ğŸšˆ", "ğŸš‚", "ğŸš†", "ğŸš‡", "ğŸšŠ", "ğŸš‰", "âœˆï¸", "ğŸ›«", "ğŸ›¬", "ğŸ›©ï¸", "ğŸ’º", "ğŸ›°ï¸", "ğŸš€", "ğŸ›¸", "ğŸš", "ğŸ›¶", "â›µ", "ğŸš¤", "ğŸ›¥ï¸", "ğŸ›³ï¸", "â›´ï¸", "ğŸš¢", "âš“", "ğŸª", "â›½", "ğŸš§", "ğŸš¦", "ğŸš¥", "ğŸš", "ğŸ—ºï¸", "ğŸ—¿", "ğŸ—½", "ğŸ—¼", "ğŸ°", "ğŸ¯", "ğŸŸï¸", "ğŸ¡", "ğŸ¢", "ğŸ ", "â›²", "â›±ï¸", "ğŸ–ï¸", "ğŸï¸", "ğŸœï¸", "ğŸŒ‹", "â›°ï¸", "ğŸ”ï¸", "ğŸ—»", "ğŸ•ï¸", "â›º", "ğŸ ", "ğŸ¡", "ğŸ˜ï¸", "ğŸšï¸", "ğŸ—ï¸", "ğŸ­", "ğŸ¢", "ğŸ¬", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¦", "ğŸ¨", "ğŸª", "ğŸ«", "ğŸ©", "ğŸ’’", "ğŸ›ï¸", "â›ª", "ğŸ•Œ", "ğŸ•", "ğŸ›•", "ğŸ•‹", "â›©ï¸", "ğŸ›¤ï¸", "ğŸ›£ï¸", "ğŸ—¾", "ğŸ‘", "ğŸï¸", "ğŸŒ…", "ğŸŒ„", "ğŸŒ ", "ğŸ‡", "ğŸ†", "ğŸŒ‡", "ğŸŒ†", "ğŸ™ï¸", "ğŸŒƒ", "ğŸŒŒ", "ğŸŒ‰", "ğŸŒ"] },
    { id: "objects", label: "Objects", icon: "ğŸ’¡", emojis: ["âŒš", "ğŸ“±", "ğŸ“²", "ğŸ’»", "âŒ¨ï¸", "ğŸ–¥ï¸", "ğŸ–¨ï¸", "ğŸ–±ï¸", "ğŸ–²ï¸", "ğŸ•¹ï¸", "ğŸ—œï¸", "ğŸ’½", "ğŸ’¾", "ğŸ’¿", "ğŸ“€", "ğŸ“¼", "ğŸ“·", "ğŸ“¸", "ğŸ“¹", "ğŸ¥", "ğŸ“½ï¸", "ğŸï¸", "ğŸ“", "â˜ï¸", "ğŸ“Ÿ", "ğŸ“ ", "ğŸ“º", "ğŸ“»", "ğŸ™ï¸", "ğŸšï¸", "ğŸ›ï¸", "ğŸ§­", "â±ï¸", "â²ï¸", "â°", "ğŸ•°ï¸", "âŒ›", "â³", "ğŸ“¡", "ğŸ”‹", "ğŸ”Œ", "ğŸ’¡", "ğŸ”¦", "ğŸ•¯ï¸", "ğŸª”", "ğŸ§¯", "ğŸ›¢ï¸", "ğŸ’¸", "ğŸ’µ", "ğŸ’´", "ğŸ’¶", "ğŸ’·", "ğŸª™", "ğŸ’°", "ğŸ’³", "ğŸ’", "âš–ï¸", "ğŸªœ", "ğŸ§°", "ğŸª›", "ğŸ”§", "ğŸ”¨", "âš’ï¸", "ğŸ› ï¸", "â›ï¸", "ğŸªš", "ğŸ”©", "âš™ï¸", "ğŸª¤", "ğŸ§±", "â›“ï¸", "ğŸ§²", "ğŸ”«", "ğŸ’£", "ğŸ§¨", "ğŸª“", "ğŸ”ª", "ğŸ—¡ï¸", "âš”ï¸", "ğŸ›¡ï¸", "ğŸš¬", "âš°ï¸", "ğŸª¦", "âš±ï¸", "ğŸº", "ğŸ”®", "ğŸ“¿", "ğŸ§¿", "ğŸ’ˆ", "âš—ï¸", "ğŸ”­", "ğŸ”¬", "ğŸ•³ï¸", "ğŸ©¹", "ğŸ©º", "ğŸ’Š", "ğŸ’‰", "ğŸ©¸", "ğŸ§¬", "ğŸ¦ ", "ğŸ§«", "ğŸ§ª", "ğŸŒ¡ï¸", "ğŸ§¹", "ğŸª ", "ğŸ§º", "ğŸ§»", "ğŸš½", "ğŸš°", "ğŸš¿", "ğŸ›", "ğŸ›€", "ğŸ§¼", "ğŸª¥", "ğŸª’", "ğŸ§½", "ğŸª£", "ğŸ§´", "ğŸ›ï¸", "ğŸ”‘", "ğŸ—ï¸", "ğŸšª", "ğŸª‘", "ğŸ›‹ï¸", "ğŸ›ï¸", "ğŸ›Œ", "ğŸ§¸", "ğŸª†", "ğŸ–¼ï¸", "ğŸª", "ğŸªŸ", "ğŸ›ï¸", "ğŸ›’", "ğŸ", "ğŸˆ", "ğŸ", "ğŸ€", "ğŸª„", "ğŸª…", "ğŸŠ", "ğŸ‰", "ğŸ", "ğŸ®", "ğŸ", "ğŸ§§", "âœ‰ï¸", "ğŸ“©", "ğŸ“¨", "ğŸ“§", "ğŸ’Œ", "ğŸ“¥", "ğŸ“¤", "ğŸ“¦", "ğŸ·ï¸", "ğŸª§", "ğŸ“ª", "ğŸ“«", "ğŸ“¬", "ğŸ“­", "ğŸ“®", "ğŸ“¯", "ğŸ“œ", "ğŸ“ƒ", "ğŸ“„", "ğŸ“‘", "ğŸ§¾", "ğŸ“Š", "ğŸ“ˆ", "ğŸ“‰", "ğŸ—’ï¸", "ğŸ—“ï¸", "ğŸ“†", "ğŸ“…", "ğŸ—‘ï¸", "ğŸ“‡", "ğŸ—ƒï¸", "ğŸ—³ï¸", "ğŸ—„ï¸", "ğŸ“‹", "ğŸ“", "ğŸ“‚", "ğŸ—‚ï¸", "ğŸ—ï¸", "ğŸ“°", "ğŸ““", "ğŸ“”", "ğŸ“’", "ğŸ“•", "ğŸ“—", "ğŸ“˜", "ğŸ“™", "ğŸ“š", "ğŸ“–", "ğŸ”–", "ğŸ§·", "ğŸ”—", "ğŸ“", "ğŸ–‡ï¸", "ğŸ“", "ğŸ“", "ğŸ§®", "ğŸ“Œ", "ğŸ“", "âœ‚ï¸", "ğŸ–Šï¸", "ğŸ–‹ï¸", "âœ’ï¸", "ğŸ–Œï¸", "ğŸ–ï¸", "ğŸ“", "âœï¸", "ğŸ”", "ğŸ”", "ğŸ”", "ğŸ”", "ğŸ”’", "ğŸ”“"] },
    { id: "symbols", label: "Symbols", icon: "â¤ï¸", emojis: ["â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ–¤", "ğŸ¤", "ğŸ¤", "ğŸ’”", "â£ï¸", "ğŸ’•", "ğŸ’", "ğŸ’“", "ğŸ’—", "ğŸ’–", "ğŸ’˜", "ğŸ’", "ğŸ’Ÿ", "â˜®ï¸", "âœï¸", "â˜ªï¸", "ğŸ•‰ï¸", "â˜¸ï¸", "âœ¡ï¸", "ğŸ”¯", "ğŸ•", "â˜¯ï¸", "â˜¦ï¸", "ğŸ›", "â›", "â™ˆ", "â™‰", "â™Š", "â™‹", "â™Œ", "â™", "â™", "â™", "â™", "â™‘", "â™’", "â™“", "ğŸ†”", "âš›ï¸", "ğŸ‰‘", "â˜¢ï¸", "â˜£ï¸", "ğŸ“´", "ğŸ“³", "ğŸˆ¶", "ğŸˆš", "ğŸˆ¸", "ğŸˆº", "ğŸˆ·ï¸", "âœ´ï¸", "ğŸ†š", "ğŸ’®", "ğŸ‰", "ãŠ™ï¸", "ãŠ—ï¸", "ğŸˆ´", "ğŸˆµ", "ğŸˆ¹", "ğŸˆ²", "ğŸ…°ï¸", "ğŸ…±ï¸", "ğŸ†", "ğŸ†‘", "ğŸ…¾ï¸", "ğŸ†˜", "âŒ", "â­•", "ğŸ›‘", "â›”", "ğŸ“›", "ğŸš«", "ğŸ’¯", "ğŸ’¢", "â™¨ï¸", "ğŸš·", "ğŸš¯", "ğŸš³", "ğŸš±", "ğŸ”", "ğŸš­", "â—", "â•", "â“", "â”", "â€¼ï¸", "â‰ï¸", "ğŸ”…", "ğŸ”†", "ã€½ï¸", "âš ï¸", "ğŸš¸", "ğŸ”±", "âšœï¸", "ğŸ”°", "â™»ï¸", "âœ…", "ğŸˆ¯", "ğŸ’¹", "â‡ï¸", "âœ³ï¸", "â", "ğŸŒ", "ğŸ’ ", "â“‚ï¸", "ğŸŒ€", "ğŸ’¤", "ğŸ§", "ğŸš¾", "â™¿", "ğŸ…¿ï¸", "ğŸ›—", "ğŸˆ³", "ğŸˆ‚ï¸", "ğŸ›‚", "ğŸ›ƒ", "ğŸ›„", "ğŸ›…", "ğŸš¹", "ğŸšº", "ğŸš¼", "ğŸš»", "ğŸš®", "ğŸ¦", "ğŸ“¶", "ğŸˆ", "ğŸ”£", "â„¹ï¸", "ğŸ”¤", "ğŸ”¡", "ğŸ” ", "ğŸ†–", "ğŸ†—", "ğŸ†™", "ğŸ†’", "ğŸ†•", "ğŸ†“", "0ï¸âƒ£", "1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£", "7ï¸âƒ£", "8ï¸âƒ£", "9ï¸âƒ£", "ğŸ”Ÿ", "ğŸ”¢", "#ï¸âƒ£", "*ï¸âƒ£", "âï¸", "â–¶ï¸", "â¸ï¸", "â¯ï¸", "â¹ï¸", "âºï¸", "â­ï¸", "â®ï¸", "â©", "âª", "â«", "â¬", "â—€ï¸", "ğŸ”¼", "ğŸ”½", "â¡ï¸", "â¬…ï¸", "â¬†ï¸", "â¬‡ï¸", "â†—ï¸", "â†˜ï¸", "â†™ï¸", "â†–ï¸", "â†•ï¸", "â†”ï¸", "â†ªï¸", "â†©ï¸", "â¤´ï¸", "â¤µï¸", "ğŸ”€", "ğŸ”", "ğŸ”‚", "ğŸ”„", "ğŸ”ƒ", "ğŸµ", "ğŸ¶", "â•", "â–", "â—", "âœ–ï¸", "â™¾ï¸", "ğŸ’²", "ğŸ’±", "â„¢ï¸", "Â©ï¸", "Â®ï¸", "ğŸ‘ï¸â€ğŸ—¨ï¸", "ğŸ”š", "ğŸ”™", "ğŸ”›", "ğŸ”", "ğŸ”œ", "ã€°ï¸", "â°", "â¿", "âœ”ï¸", "â˜‘ï¸", "ğŸ”˜", "ğŸ”´", "ğŸŸ ", "ğŸŸ¡", "ğŸŸ¢", "ğŸ”µ", "ğŸŸ£", "âš«", "âšª", "ğŸŸ¤", "ğŸ”º", "ğŸ”»", "ğŸ”¸", "ğŸ”¹", "ğŸ”¶", "ğŸ”·", "ğŸ”³", "ğŸ”²", "â–ªï¸", "â–«ï¸", "â—¾", "â—½", "â—¼ï¸", "â—»ï¸", "ğŸŸ¥", "ğŸŸ§", "ğŸŸ¨", "ğŸŸ©", "ğŸŸ¦", "ğŸŸª", "ğŸŸ«", "â¬›", "â¬œ", "ğŸ”ˆ", "ğŸ”‡", "ğŸ”‰", "ğŸ”Š", "ğŸ””", "ğŸ”•", "ğŸ“£", "ğŸ“¢", "ğŸ’¬", "ğŸ’­", "ğŸ—¯ï¸", "â™ ï¸", "â™£ï¸", "â™¥ï¸", "â™¦ï¸", "ğŸƒ", "ğŸ´", "ğŸ€„", "ğŸ•", "ğŸ•‘", "ğŸ•’", "ğŸ•“", "ğŸ•”", "ğŸ••", "ğŸ•–", "ğŸ•—", "ğŸ•˜", "ğŸ•™", "ğŸ•š", "ğŸ•›", "ğŸ•œ", "ğŸ•", "ğŸ•", "ğŸ•Ÿ", "ğŸ• ", "ğŸ•¡", "ğŸ•¢", "ğŸ•£", "ğŸ•¤", "ğŸ•¥", "ğŸ•¦", "ğŸ•§"] },
    { id: "flags", label: "Flags", icon: "ğŸ", emojis: ["ğŸ³ï¸", "ğŸ´", "ğŸ", "ğŸš©", "ğŸ³ï¸â€ğŸŒˆ", "ğŸ³ï¸â€âš§ï¸", "ğŸ´â€â˜ ï¸", "ğŸ‡¦ğŸ‡«", "ğŸ‡¦ğŸ‡½", "ğŸ‡¦ğŸ‡±", "ğŸ‡©ğŸ‡¿", "ğŸ‡¦ğŸ‡¸", "ğŸ‡¦ğŸ‡©", "ğŸ‡¦ğŸ‡´", "ğŸ‡¦ğŸ‡®", "ğŸ‡¦ğŸ‡¶", "ğŸ‡¦ğŸ‡¬", "ğŸ‡¦ğŸ‡·", "ğŸ‡¦ğŸ‡²", "ğŸ‡¦ğŸ‡¼", "ğŸ‡¦ğŸ‡º", "ğŸ‡¦ğŸ‡¹", "ğŸ‡¦ğŸ‡¿", "ğŸ‡§ğŸ‡¸", "ğŸ‡§ğŸ‡­", "ğŸ‡§ğŸ‡©", "ğŸ‡§ğŸ‡§", "ğŸ‡§ğŸ‡¾", "ğŸ‡§ğŸ‡ª", "ğŸ‡§ğŸ‡¿", "ğŸ‡§ğŸ‡¯", "ğŸ‡§ğŸ‡²", "ğŸ‡§ğŸ‡¹", "ğŸ‡§ğŸ‡´", "ğŸ‡§ğŸ‡¦", "ğŸ‡§ğŸ‡¼", "ğŸ‡§ğŸ‡·", "ğŸ‡®ğŸ‡´", "ğŸ‡»ğŸ‡¬", "ğŸ‡§ğŸ‡³", "ğŸ‡§ğŸ‡¬", "ğŸ‡§ğŸ‡«", "ğŸ‡§ğŸ‡®", "ğŸ‡°ğŸ‡­", "ğŸ‡¨ğŸ‡²", "ğŸ‡¨ğŸ‡¦", "ğŸ‡®ğŸ‡¨", "ğŸ‡¨ğŸ‡»", "ğŸ‡§ğŸ‡¶", "ğŸ‡°ğŸ‡¾", "ğŸ‡¨ğŸ‡«", "ğŸ‡¹ğŸ‡©", "ğŸ‡¨ğŸ‡±", "ğŸ‡¨ğŸ‡³", "ğŸ‡¨ğŸ‡½", "ğŸ‡¨ğŸ‡¨", "ğŸ‡¨ğŸ‡´", "ğŸ‡°ğŸ‡²", "ğŸ‡¨ğŸ‡¬", "ğŸ‡¨ğŸ‡©", "ğŸ‡¨ğŸ‡°", "ğŸ‡¨ğŸ‡·", "ğŸ‡¨ğŸ‡®", "ğŸ‡­ğŸ‡·", "ğŸ‡¨ğŸ‡º", "ğŸ‡¨ğŸ‡¼", "ğŸ‡¨ğŸ‡¾", "ğŸ‡¨ğŸ‡¿", "ğŸ‡©ğŸ‡°", "ğŸ‡©ğŸ‡¯", "ğŸ‡©ğŸ‡²", "ğŸ‡©ğŸ‡´", "ğŸ‡ªğŸ‡¨", "ğŸ‡ªğŸ‡¬", "ğŸ‡¸ğŸ‡»", "ğŸ‡¬ğŸ‡¶", "ğŸ‡ªğŸ‡·", "ğŸ‡ªğŸ‡ª", "ğŸ‡ªğŸ‡¹", "ğŸ‡ªğŸ‡º", "ğŸ‡«ğŸ‡°", "ğŸ‡«ğŸ‡´", "ğŸ‡«ğŸ‡¯", "ğŸ‡«ğŸ‡®", "ğŸ‡«ğŸ‡·", "ğŸ‡¬ğŸ‡«", "ğŸ‡µğŸ‡«", "ğŸ‡¹ğŸ‡«", "ğŸ‡¬ğŸ‡¦", "ğŸ‡¬ğŸ‡²", "ğŸ‡¬ğŸ‡ª", "ğŸ‡©ğŸ‡ª", "ğŸ‡¬ğŸ‡­", "ğŸ‡¬ğŸ‡®", "ğŸ‡¬ğŸ‡·", "ğŸ‡¬ğŸ‡±", "ğŸ‡¬ğŸ‡©", "ğŸ‡¬ğŸ‡µ", "ğŸ‡¬ğŸ‡º", "ğŸ‡¬ğŸ‡¹", "ğŸ‡¬ğŸ‡¬", "ğŸ‡¬ğŸ‡³", "ğŸ‡¬ğŸ‡¼", "ğŸ‡¬ğŸ‡¾", "ğŸ‡­ğŸ‡¹", "ğŸ‡­ğŸ‡³", "ğŸ‡­ğŸ‡°", "ğŸ‡­ğŸ‡º", "ğŸ‡®ğŸ‡¸", "ğŸ‡®ğŸ‡³", "ğŸ‡®ğŸ‡©", "ğŸ‡®ğŸ‡·", "ğŸ‡®ğŸ‡¶", "ğŸ‡®ğŸ‡ª", "ğŸ‡®ğŸ‡²", "ğŸ‡®ğŸ‡±", "ğŸ‡®ğŸ‡¹", "ğŸ‡¯ğŸ‡²", "ğŸ‡¯ğŸ‡µ", "ğŸŒ", "ğŸ‡¯ğŸ‡ª", "ğŸ‡¯ğŸ‡´", "ğŸ‡°ğŸ‡¿", "ğŸ‡°ğŸ‡ª", "ğŸ‡°ğŸ‡®", "ğŸ‡½ğŸ‡°", "ğŸ‡°ğŸ‡¼", "ğŸ‡°ğŸ‡¬", "ğŸ‡±ğŸ‡¦", "ğŸ‡±ğŸ‡»", "ğŸ‡±ğŸ‡§", "ğŸ‡±ğŸ‡¸", "ğŸ‡±ğŸ‡·", "ğŸ‡±ğŸ‡¾", "ğŸ‡±ğŸ‡®", "ğŸ‡±ğŸ‡¹", "ğŸ‡±ğŸ‡º", "ğŸ‡²ğŸ‡´", "ğŸ‡²ğŸ‡°", "ğŸ‡²ğŸ‡¬", "ğŸ‡²ğŸ‡¼", "ğŸ‡²ğŸ‡¾", "ğŸ‡²ğŸ‡»", "ğŸ‡²ğŸ‡±", "ğŸ‡²ğŸ‡¹", "ğŸ‡²ğŸ‡­", "ğŸ‡²ğŸ‡¶", "ğŸ‡²ğŸ‡·", "ğŸ‡²ğŸ‡º", "ğŸ‡¾ğŸ‡¹", "ğŸ‡²ğŸ‡½", "ğŸ‡«ğŸ‡²", "ğŸ‡²ğŸ‡©", "ğŸ‡²ğŸ‡¨", "ğŸ‡²ğŸ‡³", "ğŸ‡²ğŸ‡ª", "ğŸ‡²ğŸ‡¸", "ğŸ‡²ğŸ‡¦", "ğŸ‡²ğŸ‡¿", "ğŸ‡²ğŸ‡²", "ğŸ‡³ğŸ‡¦", "ğŸ‡³ğŸ‡·", "ğŸ‡³ğŸ‡µ", "ğŸ‡³ğŸ‡±", "ğŸ‡³ğŸ‡¨", "ğŸ‡³ğŸ‡¿", "ğŸ‡³ğŸ‡®", "ğŸ‡³ğŸ‡ª", "ğŸ‡³ğŸ‡¬", "ğŸ‡³ğŸ‡º", "ğŸ‡³ğŸ‡«", "ğŸ‡°ğŸ‡µ", "ğŸ‡²ğŸ‡µ", "ğŸ‡³ğŸ‡´", "ğŸ‡´ğŸ‡²", "ğŸ‡µğŸ‡°", "ğŸ‡µğŸ‡¼", "ğŸ‡µğŸ‡¸", "ğŸ‡µğŸ‡¦", "ğŸ‡µğŸ‡¬", "ğŸ‡µğŸ‡¾", "ğŸ‡µğŸ‡ª", "ğŸ‡µğŸ‡­", "ğŸ‡µğŸ‡³", "ğŸ‡µğŸ‡±", "ğŸ‡µğŸ‡¹", "ğŸ‡µğŸ‡·", "ğŸ‡¶ğŸ‡¦", "ğŸ‡·ğŸ‡ª", "ğŸ‡·ğŸ‡´", "ğŸ‡·ğŸ‡º", "ğŸ‡·ğŸ‡¼", "ğŸ‡¼ğŸ‡¸", "ğŸ‡¸ğŸ‡²", "ğŸ‡¸ğŸ‡¹", "ğŸ‡¸ğŸ‡¦", "ğŸ‡¸ğŸ‡³", "ğŸ‡¸ğŸ‡¨", "ğŸ‡¸ğŸ‡±", "ğŸ‡¸ğŸ‡¬", "ğŸ‡¸ğŸ‡½", "ğŸ‡¸ğŸ‡°", "ğŸ‡¸ğŸ‡®", "ğŸ‡¬ğŸ‡¸", "ğŸ‡¸ğŸ‡§", "ğŸ‡¸ğŸ‡´", "ğŸ‡¿ğŸ‡¦", "ğŸ‡°ğŸ‡·", "ğŸ‡¸ğŸ‡¸", "ğŸ‡ªğŸ‡¸", "ğŸ‡±ğŸ‡°", "ğŸ‡§ğŸ‡±", "ğŸ‡¸ğŸ‡­", "ğŸ‡°ğŸ‡³", "ğŸ‡±ğŸ‡¨", "ğŸ‡µğŸ‡²", "ğŸ‡»ğŸ‡¨", "ğŸ‡¸ğŸ‡©", "ğŸ‡¸ğŸ‡·", "ğŸ‡¸ğŸ‡¿", "ğŸ‡¸ğŸ‡ª", "ğŸ‡¨ğŸ‡­", "ğŸ‡¸ğŸ‡¾", "ğŸ‡¹ğŸ‡¼", "ğŸ‡¹ğŸ‡¯", "ğŸ‡¹ğŸ‡¿", "ğŸ‡¹ğŸ‡­", "ğŸ‡¹ğŸ‡±", "ğŸ‡¹ğŸ‡¬", "ğŸ‡¹ğŸ‡°", "ğŸ‡¹ğŸ‡´", "ğŸ‡¹ğŸ‡¹", "ğŸ‡¹ğŸ‡³", "ğŸ‡¹ğŸ‡·", "ğŸ‡¹ğŸ‡²", "ğŸ‡¹ğŸ‡¨", "ğŸ‡¹ğŸ‡»", "ğŸ‡ºğŸ‡¬", "ğŸ‡ºğŸ‡¦", "ğŸ‡¦ğŸ‡ª", "ğŸ‡¬ğŸ‡§", "ğŸ‡ºğŸ‡¸", "ğŸ‡ºğŸ‡¾", "ğŸ‡ºğŸ‡¿", "ğŸ‡»ğŸ‡º", "ğŸ‡»ğŸ‡¦", "ğŸ‡»ğŸ‡ª", "ğŸ‡»ğŸ‡³", "ğŸ‡¼ğŸ‡«", "ğŸ‡ªğŸ‡­", "ğŸ‡¾ğŸ‡ª", "ğŸ‡¿ğŸ‡²", "ğŸ‡¿ğŸ‡¼", "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿", "ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿", "ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿"] },
];

export default function EmojiPicker({ value, onChange, className = "", guildId }: EmojiPickerProps) {
    const [isOpen, setIsOpen] = useState(false);
    const [search, setSearch] = useState("");
    const [activeCategory, setActiveCategory] = useState("people");
    const [customEmojis, setCustomEmojis] = useState<CustomEmoji[]>([]);
    const [hoveredEmoji, setHoveredEmoji] = useState<{ emoji: string, name: string } | null>(null);

    const pickerRef = useRef<HTMLDivElement>(null);
    const scrollRef = useRef<HTMLDivElement>(null);

    // Fetch Custom Emojis
    useEffect(() => {
        if (guildId && isOpen) {
            fetch(`/api/emojis?guild_id=${guildId}`)
                .then(res => res.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        setCustomEmojis(data);
                    }
                })
                .catch(err => console.error("Failed to fetch emojis", err));
        }
    }, [guildId, isOpen]);

    // Click Outside Handling
    useEffect(() => {
        function handleClickOutside(event: MouseEvent) {
            if (pickerRef.current && !pickerRef.current.contains(event.target as Node)) {
                setIsOpen(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleSelect = (emoji: string) => {
        onChange(emoji);
        setIsOpen(false);
        setSearch("");
    };

    // Scroll to category
    const scrollToCategory = (catId: string) => {
        setActiveCategory(catId);
        const element = document.getElementById(`emoji-cat-${catId}`);
        if (element && scrollRef.current) {
            scrollRef.current.scrollTo({ top: element.offsetTop - 10, behavior: "smooth" });
        }
    };

    // Filter Logic
    const filteredCategories = useMemo(() => {
        const term = search.toLowerCase();
        if (!term) return { categories: CATEGORIES, custom: customEmojis };

        const filteredStandard = CATEGORIES.map(cat => ({
            ...cat,
            emojis: cat.emojis.filter(e => e.includes(term)) // Naive check, ideally use keywords
        })).filter(cat => cat.emojis.length > 0);

        const filteredCustom = customEmojis.filter(e => e.name.toLowerCase().includes(term));

        return { categories: filteredStandard, custom: filteredCustom };
    }, [search, customEmojis]);

    // Handle Custom Input Enter
    const handleCustomInput = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Enter') {
            handleSelect((e.target as HTMLInputElement).value);
        }
    };

    return (
        <div className={`relative ${className}`} ref={pickerRef}>
            {/* Trigger Button */}
            <button
                type="button"
                onClick={() => setIsOpen(!isOpen)}
                className="w-14 h-10 flex items-center justify-center text-xl bg-white border-2 border-stone-200 rounded-lg hover:border-amber-400 hover:bg-amber-50 transition cursor-pointer"
            >
                {value.includes('<') ? <img src={`https://cdn.discordapp.com/emojis/${value.split(':')[2].slice(0, -1)}.png`} className="w-6 h-6" alt="emoji" /> : (value || "ğŸ˜€")}
            </button>

            {/* Picker Modal */}
            {isOpen && (
                <div className="absolute z-50 top-12 left-0 w-[420px] h-[450px] bg-[#2B2D31] rounded-lg shadow-2xl border border-[#1e1f22] overflow-hidden flex flex-col font-sans select-none animate-in fade-in zoom-in-95 duration-150">

                    {/* Header: Search */}
                    <div className="p-4 bg-[#2B2D31] border-b border-[#1e1f22]">
                        <input
                            type="text"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            placeholder="Find an emoji"
                            className="w-full px-3 py-2 bg-[#1E1F22] text-[#DBDEE1] rounded-[4px] text-sm placeholder-[#949BA4] focus:outline-none focus:ring-1 focus:ring-[#00A8FC]"
                            autoFocus
                        />
                    </div>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar */}
                        <div className="w-12 bg-[#2B2D31] flex flex-col items-center gap-1 py-2 overflow-y-auto no-scrollbar border-r border-[#1e1f22]">
                            {/* Custom Server Icon */}
                            {customEmojis.length > 0 && (
                                <button
                                    onClick={() => scrollToCategory('custom')}
                                    className={`w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-[#404249] ${activeCategory === 'custom' ? 'bg-[#404249] rounded-[10px]' : ''}`}
                                    title="Server Emojis"
                                >
                                    {/* Server Icon Placeholder or Guild Icon if available */}
                                    <span className="text-lg">ğŸ°</span>
                                </button>
                            )}

                            {CATEGORIES.map(cat => (
                                <button
                                    key={cat.id}
                                    onClick={() => scrollToCategory(cat.id)}
                                    className={`w-8 h-8 rounded-full flex items-center justify-center transition hover:bg-[#404249] ${activeCategory === cat.id ? 'bg-[#404249] rounded-[10px]' : ''}`}
                                    title={cat.label}
                                >
                                    <span className="text-lg text-[#DBDEE1] grayscale hover:grayscale-0 transition">{cat.icon}</span>
                                </button>
                            ))}
                        </div>

                        {/* Emoji Grid */}
                        <div
                            className="flex-1 bg-[#2B2D31] overflow-y-auto custom-scrollbar px-2 relative"
                            ref={scrollRef}
                            onScroll={() => {
                                if (!scrollRef.current) return;
                                const container = scrollRef.current;
                                const containerTop = container.scrollTop;

                                // Check Custom Category
                                const customEl = document.getElementById('emoji-cat-custom');
                                if (customEl) {
                                    if (customEl.offsetTop <= containerTop + 50 && (customEl.offsetTop + customEl.offsetHeight) > containerTop) {
                                        setActiveCategory('custom');
                                        return;
                                    }
                                }

                                // Check Standard Categories
                                for (const cat of CATEGORIES) {
                                    const el = document.getElementById(`emoji-cat-${cat.id}`);
                                    if (el) {
                                        // 50px offset for sticky header calculation
                                        if (el.offsetTop <= containerTop + 50 && (el.offsetTop + el.offsetHeight) > containerTop) {
                                            setActiveCategory(cat.id);
                                            break;
                                        }
                                    }
                                }
                            }}
                        >

                            {/* Custom Emojis Section */}
                            {(search ? filteredCategories.custom.length > 0 : customEmojis.length > 0) && (
                                <div id="emoji-cat-custom" className="mb-4 mt-2">
                                    <h3 className="text-xs font-bold text-[#949BA4] uppercase mb-2 sticky top-0 bg-[#2B2D31] py-2 z-20 border-b border-[#1e1f22]">
                                        Server Emojis
                                    </h3>
                                    <div className="grid grid-cols-7 gap-1 pt-1">
                                        {(search ? filteredCategories.custom : customEmojis).map(e => (
                                            <button
                                                key={e.id}
                                                onClick={() => handleSelect(`<${e.animated ? 'a' : ''}:${e.name}:${e.id}>`)}
                                                onMouseEnter={() => setHoveredEmoji({ emoji: `https://cdn.discordapp.com/emojis/${e.id}.png`, name: `:${e.name}:` })}
                                                onMouseLeave={() => setHoveredEmoji(null)}
                                                className="w-10 h-10 flex items-center justify-center hover:bg-[#404249] rounded transition"
                                            >
                                                <img src={`https://cdn.discordapp.com/emojis/${e.id}.png`} alt={e.name} className="w-8 h-8 object-contain" />
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Standard Categories */}
                            {filteredCategories.categories.map(cat => (
                                <div key={cat.id} id={`emoji-cat-${cat.id}`} className="mb-4">
                                    <h3 className="text-xs font-bold text-[#949BA4] uppercase mb-2 sticky top-0 bg-[#2B2D31] py-2 z-20 border-b border-[#1e1f22]">
                                        {cat.label}
                                    </h3>
                                    <div className="grid grid-cols-7 gap-1 pt-1">
                                        {cat.emojis.map((emoji) => (
                                            <button
                                                key={emoji}
                                                onClick={() => handleSelect(emoji)}
                                                onMouseEnter={() => setHoveredEmoji({ emoji, name: emoji })}
                                                onMouseLeave={() => setHoveredEmoji(null)}
                                                className="w-10 h-10 flex items-center justify-center text-2xl hover:bg-[#404249] rounded transition"
                                            >
                                                {emoji}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}

                            {/* No Results */}
                            {search && filteredCategories.categories.length === 0 && filteredCategories.custom.length === 0 && (
                                <div className="text-center py-10 text-[#949BA4]">
                                    <div className="text-4xl mb-2">ğŸ¤”</div>
                                    <p className="font-bold">No matching emojis found</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Footer / Hover Preview */}
                    <div className="h-12 bg-[#2B2D31] border-t border-[#1e1f22] flex items-center px-4 gap-3">
                        {hoveredEmoji ? (
                            <>
                                {hoveredEmoji.emoji.startsWith('http') ? (
                                    <img src={hoveredEmoji.emoji} className="w-8 h-8" alt="preview" />
                                ) : (
                                    <span className="text-3xl">{hoveredEmoji.emoji}</span>
                                )}
                                <span className="font-medium text-[#DBDEE1] text-sm">{hoveredEmoji.name}</span>
                            </>
                        ) : (
                            <div className="flex-1 flex gap-2 w-full">
                                <input
                                    type="text"
                                    placeholder="Or paste custom emoji string..."
                                    className="flex-1 bg-[#1E1F22] text-[#DBDEE1] text-xs px-2 py-1.5 rounded outline-none border border-transparent focus:border-[#00A8FC]"
                                    onKeyDown={handleCustomInput}
                                />
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}

